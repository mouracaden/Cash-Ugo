<!DOCTYPE html>
<html lang="fr" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>L'Ugo-mètre | Calculateur de Coût de Réunion</title>
    
    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&family=JetBrains+Mono:wght@400;700&display=swap" rel="stylesheet">
    
    <!-- Tailwind CSS (CDN) -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Icons (Lucide) -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <!-- Config Tailwind -->
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                        mono: ['JetBrains Mono', 'monospace'],
                    },
                    colors: {
                        emerald: {
                            400: '#34d399',
                            500: '#10b981',
                            600: '#059669',
                            900: '#064e3b',
                            950: '#022c22',
                        },
                        gray: {
                            850: '#1f2937',
                            900: '#111827',
                            950: '#030712', // Deep dark
                        }
                    },
                    animation: {
                        'pulse-glow': 'pulse-glow 2s cubic-bezier(0.4, 0, 0.6, 1) infinite',
                    },
                    keyframes: {
                        'pulse-glow': {
                            '0%, 100%': { opacity: 1, boxShadow: '0 0 20px rgba(16, 185, 129, 0.2)' },
                            '50%': { opacity: .8, boxShadow: '0 0 5px rgba(16, 185, 129, 0)' },
                        }
                    }
                }
            }
        }
    </script>

    <style>
        body {
            background-color: #030712;
            color: #f3f4f6;
        }
        
        /* Utilitaires custom */
        .text-glow {
            text-shadow: 0 0 10px rgba(16, 185, 129, 0.5);
        }
        
        .hide { display: none !important; }
        
        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #111827; }
        ::-webkit-scrollbar-thumb { background: #374151; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #4b5563; }

        /* Styles d'impression (Facture) */
        @media print {
            @page { size: letter; margin: 0.5in; }
            body { background-color: white !important; color: black !important; -webkit-print-color-adjust: exact; }
            .no-print { display: none !important; }
            .print-only { display: block !important; }
            #app-container { box-shadow: none !important; border: none !important; }
            .bg-emerald-500 { background-color: #10b981 !important; color: white !important; }
            .text-emerald-600 { color: #059669 !important; }
        }
    </style>
<script type="importmap">
{
  "imports": {
    "react": "https://esm.sh/react@^19.2.3",
    "react-dom/": "https://esm.sh/react-dom@^19.2.3/",
    "react/": "https://esm.sh/react@^19.2.3/",
    "lucide-react": "https://esm.sh/lucide-react@^0.561.0",
    "vite": "https://esm.sh/vite@^7.3.0",
    "@vitejs/plugin-react": "https://esm.sh/@vitejs/plugin-react@^5.1.2"
  }
}
</script>
</head>
<body class="antialiased min-h-screen flex flex-col">

    <!-- Navbar -->
    <nav class="border-b border-gray-800 bg-gray-950/80 backdrop-blur sticky top-0 z-50 no-print">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex items-center justify-between h-16">
                <div class="flex items-center gap-3">
                    <div class="bg-emerald-900/30 p-2 rounded border border-emerald-500/20 text-emerald-400">
                        <i data-lucide="banknote" class="w-6 h-6"></i>
                    </div>
                    <span class="text-xl font-bold tracking-tight">L'Ugo<span class="text-emerald-500">-mètre</span></span>
                </div>
                <div class="flex items-center gap-4">
                    <button id="btn-reset" class="text-xs text-gray-500 hover:text-red-400 transition-colors uppercase tracking-wider font-semibold">
                        Réinitialiser
                    </button>
                    <button id="btn-settings" class="p-2 text-gray-400 hover:text-white transition-colors bg-gray-900 rounded-full border border-gray-800">
                        <i data-lucide="settings" class="w-5 h-5"></i>
                    </button>
                </div>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <main id="app" class="flex-grow flex flex-col p-4 md:p-6 max-w-7xl mx-auto w-full">
        
        <!-- VIEW 1: SETUP (Admin Panel) -->
        <div id="view-setup" class="animate-in fade-in slide-in-from-bottom-4 duration-500">
            <div class="bg-gray-900 border border-gray-800 rounded-xl p-6 shadow-2xl">
                <div class="flex items-center gap-3 mb-6 text-emerald-400">
                    <i data-lucide="users" class="w-6 h-6"></i>
                    <h2 class="text-xl font-bold">Configuration de la Réunion</h2>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                    <!-- Participants Input -->
                    <div>
                        <label class="block text-sm font-medium text-gray-300 mb-2">
                            Participants (CSV / Excel)
                        </label>
                        <p class="text-xs text-gray-500 mb-2 font-mono bg-gray-950 p-2 rounded border border-gray-800">
                            Format: Nom | Titre | Salaire Annuel
                        </p>
                        <textarea id="input-participants" class="w-full h-64 bg-gray-950 text-gray-300 border border-gray-700 rounded-lg p-4 font-mono text-sm focus:ring-2 focus:ring-emerald-500 focus:border-transparent outline-none transition-all resize-none whitespace-pre" placeholder="Ugo C.	Directeur	120000
Stagiaire	Café	0
Consultant	Expert	250000"></textarea>
                    </div>

                    <!-- Topics Input -->
                    <div>
                        <label class="block text-sm font-medium text-gray-300 mb-2">
                            Ordre du Jour (Optionnel)
                        </label>
                        <p class="text-xs text-gray-500 mb-2 font-mono bg-gray-950 p-2 rounded border border-gray-800">
                            Un sujet par ligne
                        </p>
                        <textarea id="input-topics" class="w-full h-64 bg-gray-950 text-gray-300 border border-gray-700 rounded-lg p-4 font-mono text-sm focus:ring-2 focus:ring-emerald-500 focus:border-transparent outline-none transition-all resize-none" placeholder="Mot de bienvenue
Budget Collège Sainte-Anne
Pause Café (Coûteuse)
Vision Stratégique
Varia"></textarea>
                    </div>
                </div>

                <div id="setup-error" class="mt-4 text-red-400 text-sm hidden flex items-center gap-2 bg-red-900/20 p-3 rounded">
                    <i data-lucide="alert-triangle" class="w-4 h-4"></i>
                    <span id="setup-error-msg">Erreur</span>
                </div>

                <div class="mt-8 flex justify-end">
                    <button id="btn-start-meeting" class="bg-emerald-600 hover:bg-emerald-500 text-white font-bold py-3 px-8 rounded-lg shadow-lg shadow-emerald-900/50 transition-all transform hover:scale-105 flex items-center gap-2">
                        <i data-lucide="play" class="w-5 h-5"></i>
                        Lancer le Compteur
                    </button>
                </div>
            </div>
        </div>

        <!-- VIEW 2: DASHBOARD (Live) -->
        <div id="view-dashboard" class="hide flex flex-col gap-6 h-full">
            
            <!-- Top Stats -->
            <div class="grid grid-cols-1 md:grid-cols-12 gap-6">
                <!-- Burn Rate -->
                <div class="md:col-span-3 bg-gray-900 border border-gray-800 p-5 rounded-xl flex flex-col justify-between relative overflow-hidden group">
                    <div class="absolute top-0 right-0 p-3 opacity-10">
                        <i data-lucide="flame" class="w-12 h-12"></i>
                    </div>
                    <span class="text-gray-400 text-xs uppercase tracking-wider font-semibold">Taux de combustion</span>
                    <div>
                        <span id="display-burn-rate" class="text-2xl font-mono text-gray-200 block font-bold">--</span>
                        <span class="text-xs text-gray-500 uppercase">par minute</span>
                    </div>
                </div>

                <!-- MAIN DISPLAY -->
                <div class="md:col-span-6 bg-gradient-to-b from-gray-900 to-black border border-emerald-900/50 p-6 rounded-xl flex flex-col items-center justify-center relative shadow-[0_0_50px_rgba(16,185,129,0.05)] min-h-[220px]">
                    <div class="flex items-center gap-2 mb-4">
                        <div id="indicator-dot" class="w-2.5 h-2.5 rounded-full bg-gray-600"></div>
                        <span id="indicator-text" class="text-xs font-mono text-gray-500 uppercase tracking-widest">EN ATTENTE</span>
                    </div>

                    <div class="text-center z-10 w-full">
                        <h2 id="active-topic-title" class="text-lg md:text-xl text-gray-400 font-medium mb-2 truncate px-4">Sélectionnez un sujet</h2>
                        
                        <div class="flex flex-col items-center justify-center">
                            <span id="main-counter" class="text-6xl md:text-8xl font-bold font-mono text-white tracking-tighter tabular-nums text-glow transition-all">0,00 $</span>
                            <span class="text-xs text-gray-600 uppercase tracking-widest mt-2">Coût du sujet en cours</span>
                        </div>
                    </div>
                </div>

                <!-- Total Meeting -->
                <div class="md:col-span-3 bg-gray-900 border border-gray-800 p-5 rounded-xl flex flex-col justify-center items-center text-center relative">
                    <span class="text-gray-400 text-xs uppercase tracking-wider font-semibold mb-2">Total Réunion</span>
                    <span id="display-total-cost" class="text-3xl font-mono text-emerald-400 font-bold mb-2">0,00 $</span>
                    <p id="witty-remark" class="text-[10px] text-gray-500 font-mono h-4 italic">En attente du démarrage...</p>
                </div>
            </div>

            <!-- Content Area -->
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 flex-grow">
                <!-- Topic List -->
                <div class="lg:col-span-2 flex flex-col bg-gray-900 border border-gray-800 rounded-xl overflow-hidden min-h-[400px]">
                    <div class="p-4 border-b border-gray-800 bg-gray-950/50 flex justify-between items-center">
                        <h3 class="font-bold text-gray-200 flex items-center gap-2">
                            <i data-lucide="list" class="w-4 h-4 text-emerald-500"></i>
                            Ordre du Jour
                        </h3>
                        <span id="topic-progress" class="text-xs text-gray-500 bg-gray-950 px-2 py-1 rounded border border-gray-800">0 / 0</span>
                    </div>

                    <div id="topics-list" class="flex-grow overflow-y-auto p-2 space-y-2">
                        <!-- Topics injected via JS -->
                    </div>

                    <!-- Add Topic Input -->
                    <div class="p-3 bg-gray-950 border-t border-gray-800 flex gap-2">
                        <input id="new-topic-input" type="text" placeholder="Ajouter un sujet imprévu..." class="flex-grow bg-gray-900 text-sm text-white border border-gray-700 rounded px-3 py-2 outline-none focus:border-emerald-500">
                        <button id="btn-add-topic" class="bg-gray-800 hover:bg-gray-700 text-white px-4 rounded transition-colors">
                            <i data-lucide="plus" class="w-4 h-4"></i>
                        </button>
                    </div>
                </div>

                <!-- Controls -->
                <div class="flex flex-col gap-4">
                    <div class="bg-gray-900 border border-gray-800 p-6 rounded-xl flex-grow flex flex-col justify-between text-center">
                        <div>
                            <h3 class="text-gray-500 font-bold uppercase tracking-widest text-xs mb-6">Panneau de Contrôle</h3>
                            <div id="control-status" class="p-4 rounded border border-gray-800 bg-gray-950 text-gray-400 text-sm">
                                Prêt à faire chauffer la carte de crédit ?
                            </div>
                        </div>

                        <div class="mt-8">
                            <button id="btn-end-meeting" class="w-full group bg-red-900/20 hover:bg-red-600 text-red-400 hover:text-white border border-red-900/50 font-bold py-4 px-6 rounded-lg transition-all flex items-center justify-center gap-3">
                                <i data-lucide="square" class="w-5 h-5 fill-current group-hover:scale-110 transition-transform"></i>
                                TERMINER LA RÉUNION
                            </button>
                            <p class="text-[10px] text-gray-600 mt-3">Génère la facture finale et arrête le compteur.</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- VIEW 3: SUMMARY (Invoice) -->
        <div id="view-summary" class="hide animate-in fade-in zoom-in duration-500 pb-20 print:pb-0">
            <div class="max-w-4xl mx-auto">
                <div class="bg-white text-gray-900 rounded-lg shadow-2xl overflow-hidden mb-8 print:shadow-none print:rounded-none">
                    <!-- Invoice Header -->
                    <div class="bg-gray-900 text-white p-8 flex justify-between items-start border-b-4 border-emerald-500 print:bg-white print:text-black print:border-black">
                        <div>
                            <h1 class="text-3xl font-bold font-mono tracking-tighter mb-2">FACTURE RÉUNION</h1>
                            <p class="text-gray-400 text-sm print:text-gray-600">Collège Sainte-Anne</p>
                            <p class="text-gray-400 text-sm print:text-gray-600" id="invoice-date">--</p>
                        </div>
                        <div class="text-right">
                            <p class="text-sm text-gray-400 uppercase tracking-widest mb-1 print:text-gray-600">Total à payer</p>
                            <p id="invoice-total" class="text-4xl font-bold text-emerald-400 font-mono print:text-black">--</p>
                        </div>
                    </div>

                    <!-- Participants Tag Cloud -->
                    <div class="p-8 bg-gray-50 border-b border-gray-200 print:bg-white print:p-4">
                        <h3 class="text-xs font-bold text-gray-500 uppercase tracking-wider mb-3">Ressources Mobilisées</h3>
                        <div id="invoice-participants" class="flex flex-wrap gap-2">
                            <!-- JS Injected -->
                        </div>
                    </div>

                    <!-- Table -->
                    <div class="p-8 print:p-4">
                        <table class="w-full text-left">
                            <thead>
                                <tr class="border-b-2 border-gray-900 text-xs font-bold uppercase tracking-wider text-gray-600">
                                    <th class="pb-3 pl-2">Sujet</th>
                                    <th class="pb-3 text-right">Durée</th>
                                    <th class="pb-3 text-right pr-2">Coût</th>
                                </tr>
                            </thead>
                            <tbody id="invoice-body" class="font-mono text-sm">
                                <!-- JS Injected -->
                            </tbody>
                            <tfoot>
                                <tr class="bg-gray-100 print:bg-white print:border-t-2 print:border-black">
                                    <td class="pt-4 pb-4 pl-2 font-bold text-lg">TOTAL</td>
                                    <td id="invoice-total-time" class="pt-4 pb-4 text-right font-bold text-lg">--</td>
                                    <td id="invoice-total-foot" class="pt-4 pb-4 pr-2 text-right font-bold text-2xl text-emerald-600">--</td>
                                </tr>
                            </tfoot>
                        </table>
                    </div>

                    <!-- Footer -->
                    <div class="bg-gray-100 p-4 text-center text-xs text-gray-500 italic border-t border-gray-200 print:bg-white print:text-black">
                        "Le temps, c'est de l'argent. Merci pour votre contribution au PIB."
                    </div>
                </div>

                <!-- Action Buttons -->
                <div class="flex justify-center gap-4 no-print">
                    <button onclick="window.print()" class="flex items-center gap-2 bg-gray-800 hover:bg-gray-700 text-white px-6 py-3 rounded-lg transition-colors shadow">
                        <i data-lucide="printer" class="w-4 h-4"></i>
                        Imprimer / PDF
                    </button>
                    <button id="btn-new-meeting" class="flex items-center gap-2 bg-emerald-600 hover:bg-emerald-500 text-white px-6 py-3 rounded-lg shadow-lg transition-colors">
                        <i data-lucide="rotate-ccw" class="w-4 h-4"></i>
                        Nouvelle Réunion
                    </button>
                </div>
            </div>
        </div>

    </main>

    <!-- LOGIQUE JAVASCRIPT -->
    <script>
        // --- CONSTANTS & STATE ---
        const CONSTANTS = {
            DAYS_PER_YEAR: 220,
            HOURS_PER_DAY: 7.5,
            STORAGE_KEY: 'ugo-metre-state-v2'
        };

        let state = {
            participants: [], // { id, name, title, salary, ratePerSecond }
            topics: [],       // { id, title, status, duration, cost }
            activeTopicId: null,
            totalCost: 0,
            lastTick: null,
            view: 'setup' // setup, dashboard, summary
        };

        // --- DOM ELEMENTS ---
        const els = {
            views: {
                setup: document.getElementById('view-setup'),
                dashboard: document.getElementById('view-dashboard'),
                summary: document.getElementById('view-summary')
            },
            inputs: {
                participants: document.getElementById('input-participants'),
                topics: document.getElementById('input-topics'),
                newTopic: document.getElementById('new-topic-input')
            },
            dashboard: {
                burnRate: document.getElementById('display-burn-rate'),
                totalCost: document.getElementById('display-total-cost'),
                mainCounter: document.getElementById('main-counter'),
                activeTitle: document.getElementById('active-topic-title'),
                indicatorDot: document.getElementById('indicator-dot'),
                indicatorText: document.getElementById('indicator-text'),
                topicList: document.getElementById('topics-list'),
                topicProgress: document.getElementById('topic-progress'),
                wittyRemark: document.getElementById('witty-remark'),
                controlStatus: document.getElementById('control-status')
            },
            summary: {
                date: document.getElementById('invoice-date'),
                total: document.getElementById('invoice-total'),
                participants: document.getElementById('invoice-participants'),
                body: document.getElementById('invoice-body'),
                totalTime: document.getElementById('invoice-total-time'),
                totalFoot: document.getElementById('invoice-total-foot')
            }
        };

        // --- INITIALIZATION ---
        document.addEventListener('DOMContentLoaded', () => {
            lucide.createIcons();
            loadState();
            render();
            
            // Loop de mise à jour (Animation Frame pour la fluidité)
            requestAnimationFrame(tickLoop);
        });

        // --- CORE LOGIC ---

        function calculateRate(salary) {
            return salary / CONSTANTS.DAYS_PER_YEAR / CONSTANTS.HOURS_PER_DAY / 3600;
        }

        function parseCSV(text) {
            const lines = text.trim().split('\n');
            const participants = [];
            
            lines.forEach(line => {
                if (!line.trim()) return;
                
                // Détection séparateur: Tab, Point-virgule ou Virgule
                let parts;
                if (line.includes('\t')) parts = line.split('\t');
                else if (line.includes(';')) parts = line.split(';');
                else parts = line.split(',');

                if (parts.length >= 3) {
                    const name = parts[0].trim();
                    const title = parts[1].trim();
                    // Nettoyage salaire (enlève espaces, €, $ et remplace , par .)
                    const salaryRaw = parts[2].replace(/[\s€$]/g, '').replace(',', '.').replace(/[^0-9.]/g, '');
                    const salary = parseFloat(salaryRaw);

                    if (name && !isNaN(salary)) {
                        participants.push({
                            id: crypto.randomUUID(),
                            name,
                            title,
                            salary,
                            ratePerSecond: calculateRate(salary)
                        });
                    }
                }
            });
            return participants;
        }

        function startMeeting() {
            const pText = els.inputs.participants.value;
            const tText = els.inputs.topics.value;

            const participants = parseCSV(pText);
            
            if (participants.length === 0) {
                showError("Il faut au moins un participant avec un salaire valide.");
                return;
            }

            const topics = tText.split('\n')
                .map(t => t.trim())
                .filter(t => t.length > 0)
                .map(title => ({
                    id: crypto.randomUUID(),
                    title,
                    status: 'pending', // pending, active, paused, completed
                    duration: 0,
                    cost: 0
                }));
            
            if (topics.length === 0) {
                topics.push({ id: crypto.randomUUID(), title: "Sujet Général", status: 'pending', duration: 0, cost: 0 });
            }

            state.participants = participants;
            state.topics = topics;
            state.totalCost = 0;
            state.view = 'dashboard';
            
            saveState();
            render();
        }

        function startTopic(id) {
            state.lastTick = performance.now();
            state.activeTopicId = id;
            
            // Update statuses
            state.topics = state.topics.map(t => {
                if (t.id === id) return { ...t, status: 'active' };
                if (t.status === 'active') return { ...t, status: 'paused' }; // Pause others
                return t;
            });
            
            render();
            saveState();
        }

        function pauseTopic(id) {
            state.activeTopicId = null;
            state.lastTick = null;
            state.topics = state.topics.map(t => t.id === id ? { ...t, status: 'paused' } : t);
            render();
            saveState();
        }

        function finishTopic(id) {
            if (state.activeTopicId === id) {
                state.activeTopicId = null;
                state.lastTick = null;
            }
            state.topics = state.topics.map(t => t.id === id ? { ...t, status: 'completed' } : t);
            render();
            saveState();
        }

        function addTopic() {
            const title = els.inputs.newTopic.value.trim();
            if (title) {
                state.topics.push({
                    id: crypto.randomUUID(),
                    title,
                    status: 'pending',
                    duration: 0,
                    cost: 0
                });
                els.inputs.newTopic.value = '';
                renderTopicList();
                saveState();
            }
        }

        function endMeeting() {
            if(confirm("Terminer la réunion et générer la facture ?")) {
                state.view = 'summary';
                state.activeTopicId = null;
                render();
                saveState();
            }
        }

        function resetApp() {
            if(confirm("Tout effacer et recommencer ?")) {
                localStorage.removeItem(CONSTANTS.STORAGE_KEY);
                location.reload();
            }
        }

        // --- TICKER LOOP ---
        function tickLoop() {
            if (state.view === 'dashboard' && state.activeTopicId) {
                const now = performance.now();
                const delta = (now - (state.lastTick || now)) / 1000;
                state.lastTick = now;

                if (delta > 0) {
                    const burnRate = state.participants.reduce((acc, p) => acc + p.ratePerSecond, 0);
                    const costInc = burnRate * delta;

                    // Update State
                    state.totalCost += costInc;
                    const topicIndex = state.topics.findIndex(t => t.id === state.activeTopicId);
                    if (topicIndex > -1) {
                        state.topics[topicIndex].cost += costInc;
                        state.topics[topicIndex].duration += delta;
                        
                        // DOM Updates (Direct manipulation for performance)
                        els.dashboard.mainCounter.textContent = formatMoney(state.topics[topicIndex].cost);
                        els.dashboard.totalCost.textContent = formatMoney(state.totalCost);
                        
                        // Update specific topic row cost if feasible, or just let render handle it lightly
                        // For pure speed, we update the dashboard header mostly.
                    }
                }
            } else {
                state.lastTick = performance.now();
            }
            
            // Regular low-cost updates (remarks, etc)
            if (state.view === 'dashboard' && Math.random() < 0.01) {
               updateWittyRemark();
            }

            requestAnimationFrame(tickLoop);
        }

        // --- RENDERING ---
        function render() {
            // View Switching
            Object.keys(els.views).forEach(k => {
                if (k === state.view) els.views[k].classList.remove('hide');
                else els.views[k].classList.add('hide');
            });

            if (state.view === 'dashboard') {
                renderDashboard();
            } else if (state.view === 'summary') {
                renderSummary();
            }
        }

        function renderDashboard() {
            const burnRatePerMin = state.participants.reduce((acc, p) => acc + p.ratePerSecond, 0) * 60;
            els.dashboard.burnRate.textContent = formatMoney(burnRatePerMin);
            els.dashboard.totalCost.textContent = formatMoney(state.totalCost);

            const activeTopic = state.topics.find(t => t.id === state.activeTopicId);
            if (activeTopic) {
                els.dashboard.activeTitle.textContent = activeTopic.title;
                els.dashboard.mainCounter.textContent = formatMoney(activeTopic.cost);
                els.dashboard.indicatorDot.className = "w-2.5 h-2.5 rounded-full bg-red-500 animate-pulse";
                els.dashboard.indicatorText.textContent = "EN DIRECT";
                els.dashboard.indicatorText.className = "text-xs font-mono text-emerald-500 uppercase tracking-widest animate-pulse";
                els.dashboard.controlStatus.innerHTML = `<span class="text-emerald-400 font-bold">Ça coûte cher !</span> ${formatMoney(state.participants.reduce((acc, p) => acc + p.ratePerSecond, 0))} partent en fumée chaque seconde.`;
            } else {
                els.dashboard.activeTitle.textContent = "Aucun sujet actif";
                els.dashboard.mainCounter.textContent = formatMoney(0);
                els.dashboard.indicatorDot.className = "w-2.5 h-2.5 rounded-full bg-gray-600";
                els.dashboard.indicatorText.textContent = "EN PAUSE";
                els.dashboard.indicatorText.className = "text-xs font-mono text-gray-500 uppercase tracking-widest";
                els.dashboard.controlStatus.textContent = "Sélectionnez un sujet ci-contre pour démarrer.";
            }

            renderTopicList();
        }

        function renderTopicList() {
            const completedCount = state.topics.filter(t => t.status === 'completed').length;
            els.dashboard.topicProgress.textContent = `${completedCount} / ${state.topics.length}`;

            els.dashboard.topicList.innerHTML = '';
            
            state.topics.forEach(t => {
                const div = document.createElement('div');
                const isActive = t.id === state.activeTopicId;
                const isCompleted = t.status === 'completed';
                
                let rowClass = "flex items-center justify-between p-3 rounded border transition-all mb-2 ";
                if (isActive) rowClass += "bg-emerald-900/20 border-emerald-500/50 shadow-inner";
                else if (isCompleted) rowClass += "bg-gray-900/50 border-gray-800 opacity-60";
                else rowClass += "bg-gray-950 border-gray-800 hover:border-gray-700";

                div.className = rowClass;
                div.innerHTML = `
                    <div class="flex-grow min-w-0 mr-4">
                        <div class="flex items-center gap-2 mb-1">
                            <h4 class="font-medium truncate ${isActive ? 'text-white' : 'text-gray-300'}">${t.title}</h4>
                            ${isActive ? '<span class="relative flex h-2 w-2"><span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-emerald-400 opacity-75"></span><span class="relative inline-flex rounded-full h-2 w-2 bg-emerald-500"></span></span>' : ''}
                        </div>
                        <div class="flex items-center gap-4 text-xs font-mono text-gray-500">
                            <span class="flex items-center gap-1"><i data-lucide="clock" class="w-3 h-3"></i> ${formatTime(t.duration)}</span>
                            <span class="flex items-center gap-1 ${isActive ? 'text-emerald-400' : ''}"><i data-lucide="coins" class="w-3 h-3"></i> ${formatMoney(t.cost)}</span>
                        </div>
                    </div>
                    <div class="flex items-center gap-2">
                        ${!isCompleted && !isActive ? `<button onclick="startTopic('${t.id}')" class="p-2 bg-gray-800 hover:bg-emerald-600 hover:text-white text-gray-400 rounded-full transition-colors"><i data-lucide="play" class="w-4 h-4 fill-current"></i></button>` : ''}
                        ${isActive ? `<button onclick="pauseTopic('${t.id}')" class="p-2 bg-yellow-900/30 hover:bg-yellow-600 text-yellow-500 hover:text-white rounded-full transition-colors"><i data-lucide="pause" class="w-4 h-4 fill-current"></i></button>` : ''}
                        ${!isCompleted ? `<button onclick="finishTopic('${t.id}')" class="p-2 bg-gray-800 hover:bg-red-600 hover:text-white text-gray-400 rounded-full transition-colors"><i data-lucide="square" class="w-4 h-4 fill-current"></i></button>` : ''}
                    </div>
                `;
                els.dashboard.topicList.appendChild(div);
            });
            lucide.createIcons();
        }

        function renderSummary() {
            els.summary.date.textContent = new Date().toLocaleDateString('fr-CA', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric', hour: '2-digit', minute: '2-digit' });
            els.summary.total.textContent = formatMoney(state.totalCost);
            
            // Participants cloud
            els.summary.participants.innerHTML = state.participants.map(p => 
                `<span class="bg-gray-200 text-gray-800 px-2 py-1 rounded text-xs border border-gray-300 font-medium print:bg-transparent print:border-gray-400">${p.name}</span>`
            ).join('');

            // Table Body
            const activeTopics = state.topics.filter(t => t.duration > 1); // Filter minimal noise
            els.summary.body.innerHTML = activeTopics.length ? activeTopics.map(t => `
                <tr class="border-b border-gray-100 last:border-0 print:border-gray-300">
                    <td class="py-3 font-semibold text-gray-900 pl-2">${t.title}</td>
                    <td class="py-3 text-right text-gray-600 font-mono">${formatTime(t.duration)}</td>
                    <td class="py-3 text-right font-bold text-gray-900 font-mono pr-2">${formatMoney(t.cost)}</td>
                </tr>
            `).join('') : `<tr><td colspan="3" class="text-center py-4 text-gray-400 italic">Aucune donnée significative enregistrée.</td></tr>`;

            // Footer totals
            const totalSec = state.topics.reduce((acc, t) => acc + t.duration, 0);
            els.summary.totalTime.textContent = formatTime(totalSec);
            els.summary.totalFoot.textContent = formatMoney(state.totalCost);
        }

        // --- UTILS ---
        function formatMoney(amount) {
            return new Intl.NumberFormat('fr-CA', { style: 'currency', currency: 'CAD' }).format(amount);
        }

        function formatTime(seconds) {
            const h = Math.floor(seconds / 3600);
            const m = Math.floor((seconds % 3600) / 60);
            const s = Math.floor(seconds % 60);
            return `${h.toString().padStart(2,'0')}:${m.toString().padStart(2,'0')}:${s.toString().padStart(2,'0')}`;
        }

        function updateWittyRemark() {
            const cost = state.totalCost;
            let txt = "...";
            if (cost < 10) txt = "Initialisation des portefeuilles...";
            else if (cost < 50) txt = "Le prix d'un bon café est atteint.";
            else if (cost < 100) txt = "Ça chauffe doucement.";
            else if (cost < 500) txt = "On aurait pu envoyer un courriel.";
            else if (cost < 1000) txt = "Le budget 'Fournitures' souffre.";
            else if (cost < 5000) txt = "On annule le party de Noël ?";
            else txt = "Appelez la comptabilité, c'est une urgence.";
            
            if (els.dashboard.wittyRemark.textContent !== txt) {
                els.dashboard.wittyRemark.textContent = txt;
            }
        }

        function showError(msg) {
            const el = document.getElementById('setup-error');
            document.getElementById('setup-error-msg').textContent = msg;
            el.classList.remove('hidden');
            setTimeout(() => el.classList.add('hidden'), 5000);
        }

        // --- PERSISTENCE ---
        function saveState() {
            // On ne sauvegarde pas lastTick pour éviter les sauts temporels au reload
            const toSave = { ...state, lastTick: null };
            localStorage.setItem(CONSTANTS.STORAGE_KEY, JSON.stringify(toSave));
        }

        function loadState() {
            const saved = localStorage.getItem(CONSTANTS.STORAGE_KEY);
            if (saved) {
                try {
                    const parsed = JSON.parse(saved);
                    state = { ...state, ...parsed };
                    // Reset view to dashboard if we have active data but were in setup
                    if (state.participants.length > 0 && state.view === 'setup') {
                        state.view = 'dashboard';
                    }
                } catch(e) { console.error("Save load fail", e); }
            }
        }

        // --- EVENT LISTENERS ---
        document.getElementById('btn-start-meeting').addEventListener('click', startMeeting);
        document.getElementById('btn-add-topic').addEventListener('click', addTopic);
        document.getElementById('btn-end-meeting').addEventListener('click', endMeeting);
        document.getElementById('btn-new-meeting').addEventListener('click', resetApp);
        document.getElementById('btn-reset').addEventListener('click', resetApp);
        document.getElementById('btn-settings').addEventListener('click', () => {
            state.view = 'setup';
            render();
        });
        document.getElementById('new-topic-input').addEventListener('keypress', (e) => {
            if(e.key === 'Enter') addTopic();
        });

    </script>
</body>
</html>